@using TaxiCameBack.Website.App_LocalResources
@{
    Layout = "~/Views/Shared/_Home.cshtml";
}
<link href="@Url.Content("~/Content/datetimepicker/jquery.datetimepicker.css")" rel="stylesheet" />
<script src="@Url.Content("~/Content/datetimepicker/jquery.datetimepicker.full.min.js")"></script>
<!--The jQuery library is required and is referenced by default in _Layout.cshtml. -->
@Scripts.Render("~/js/signalr")
<!--Reference the autogenerated SignalR hub script. -->
<script src="~/signalr/hubs"></script>
<script>
        $(function () {
            // Reference the auto-generated proxy for the hub.
            var notification = $.connection.notificationHub;
            // Create a function that the hub can call back to display messages.
            notification.client.addNewMessageToPage = function (message) {
                window.alert(message);
            };
            // Start the connection.
            $.connection.hub.start().done(function () {
                $('#btnCreate').click(function () {
                    if ($("#customerAgreeTerm").is(':checked'))
                    {
                        CustomerRegisterCar.DriveId = $('#DriveId').val();
                        CustomerRegisterCar.CustomerFullName = $('#customerFullName').val();
                        CustomerRegisterCar.CustomerPhoneNumber = $('#customerPhoneNumber').val();
                        CustomerRegisterCar.ScheduleId = $('#ScheduleId').val();
                        CustomerRegisterCar.NearLocation = $('#customerNearpos').val();
                        // Call the Send method on the hub.
                        notification.server.registerTaxi(CustomerRegisterCar);
                    }
                    else
                    {
                        alert("Bạn cần xác nhận lại điều kiện.")
                    }
                });
            });
        });
</script>
<!--BODY_START-->
<div class="container_12 clearfix">
    <div class="grid_8 content">
        <section id="search">
            <div class="tabbable tabbable_red">
                <ul class="nav-tabs">
                    <li class="active with_icon"><a href="#search_tab_1" data-toggle="tab"><i class="icomoon-search"></i>@Home.lbl_FindCar</a></li>
                    <li class="with_icon"><a href="#search_tab_2" data-toggle="tab" id="register_div"><i class="icomoon-plus"></i>@Home.lbl_register_taxi</a></li>
                </ul>
                <div class="tab-content">
                    <div class="tab-pane active" id="search_tab_1">
                        <form id="homepage_search" action="#">
                            <div class="row">
                                <div class="span6">
                                    <label for="type" class="dropdown_label">@Home.lbl_startpoint</label>
                                    <input id="startPoint" onkeypress="return calcdir(event)" type="text" placeholder="@Home.plh_StartPoint" name="start_position">
                                </div>
                                <div class="span6">
                                    <label for="category" class="dropdown_label">@Home.lbl_endpoint</label>
                                    <input id="endPoint" onkeypress="return calcdir(event)" type="text" placeholder="@Home.plh_EndPoint" autocomplete="off" name="end_position">
                                </div>
                            </div>
                            <div class="row">
                                <div class="span6">
                                    <label for="location" class="dropdown_label">@Home.lbl_startdate</label>
                                    <input id="timestart" type="text" placeholder="@Home.plh_TimeStart" name="start_date" autocomplete="off">
                                </div>
                            </div>
                            <div class="row last_row">
                                <div class="span2">
                                </div>
                                <div class="span10 clear_submit_buttons">
                                    <a id="locate" href="#" class="clear_filters"><i class="icon-screenshot"></i> @Home.lbl_Locate</a>
                                    <a href="#"  id="switchSearchValue" class="clear_filters"><i class="icon-exchange"></i> @Home.btn_switch_title</a>
                                    <a href="#" class="clear_filters" id="clear_search"><i class="icon-remove"></i> @Home.btn_clear</a>
                                    <a class="button yellow right" id="searchCar">@Home.btn_search_title</a>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="tab-pane" id="search_tab_2">
                        <form id="homepage_search" action="#">
                            <div class="row">
                                <div class="span6">
                                    <label for="type" class="dropdown_label">@Home.lbl_startpoint</label>
                                    <input type="text" placeholder="@Home.plh_StartPoint" id="reg_start_position">
                                </div>
                                <div class="span6">
                                    <label for="category" class="dropdown_label">@Home.lbl_endpoint</label>
                                    <input type="text" placeholder="@Home.plh_EndPoint" id="reg_end_position">
                                </div>
                            </div>
                            <div class="row">
                                <div class="span6">
                                    <label for="location" class="dropdown_label">@Home.lbl_NearPos</label>
                                    <input type="text" placeholder="@Home.plh_NearPos" id="reg_near_position">
                                </div>
                            </div>
                            <div class="row">
                                <div class="span6">
                                    <label for="location" class="dropdown_label">@Home.lbl_startdate</label>
                                    <input type="text" placeholder="@Home.plh_TimeStart" id="reg_start_date">
                                </div>
                            </div>
                            <div class="row">
                                <div class="span6">
                                    <label for="location" class="dropdown_label">@Home.lbl_CustomerName</label>
                                    <input type="text" placeholder="@Home.plh_FullName" id="reg_full_name">
                                </div>
                                <div class="span6">
                                    <label for="location" class="dropdown_label">@Home.lbl_CustomerPhone</label>
                                    <input type="text" placeholder="@Home.plh_PhoneNumber" id="reg_phone_number">
                                </div>
                            </div>
                            <div class="row">
                                <div class="span12">
                                    <label for="location" class="dropdown_label">@Home.lbl_note</label>
                                    <textarea name="description" id="reg_note" placeholder="@Home.plh_note"></textarea>
                                </div>
                            </div>
                            <div class="row last_row">
                                <div class="span6">
                                </div>
                                <div class="span6 clear_submit_buttons">
                                    <a id="clearConditions" href="#" class="clear_filters"><i class="icon-remove"></i> @Home.btn_clear</a>
                                    <a id="customerRegister"  class="button submit yellow right">@Home.btn_register</a>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </section>

        <section id="vendor" class="box" style="display:none;">
            <h3>@Home.lbl_SearchResult</h3>
            <p id="no_result" class="no_results" style="display:none;">
            </p>
            <div id="search_result" class="custom_scrollbar">
            </div>
        </section>

        <section id="item_info" class="box">
            <h3>@Home.lbl_UserGuide</h3>
            <div class="box-content">
                <h5>Hướng dẫn tìm kiếm xe taxi</h5>
                <p>Nhập địa chỉ đến và đi, thời gian xuất hành vào khung tìm kiếm hoặc click vào icon <i class="icon-screenshot"></i> để hệ thống tự lấy vị trí hiện tại của bạn.</p>
                <p>Sau đó click chuột vào nút Tìm kiếm để bắt đầu quá trình tìm kiếm taxi. Hệ thống sẽ hiển thị danh sách các chuyến xe phù hợp với lộ trình của bạn, hãy đăng kí và liên hệ với tài xế để có được thông tin cần thiết.</p>
                <h5>Hướng dẫn đăng ký xe taxi</h5>
                <p>Nhập địa chỉ đến và đi, thời gian xuất hành, vị trí đón, họ tên và số điện thoại của bạn cũng như ghi chú vào khung đăng kí.</p>
                <p>Sau đó click chuột vào nút Đăng ký để thực hiện đăng ký chuyến xe. Chúng tôi sẽ liên hệ với bạn khi có chuyến xe phù hợp.</p>
            </div>
        </section>
        
        <div class="login_form_modal_container">
            <div id="login_form" class="box">
                <h3>@Home.lbl_register</h3>
                <div class="box-content clearfix">
                    <div class="row">
                        <label for="customername" class="dropdown_label">@Home.lbl_CustomerName</label>
                        <input id="customerFullName" type="text" placeholder="@Home.plh_FullName" name="fullname" maxlength="50">
                    </div>
                    <div class="row">
                        <label for="customerphone" class="dropdown_label">@Home.lbl_CustomerPhone</label>
                        <input id="customerPhoneNumber" type="text" placeholder="@Home.plh_PhoneNumber" name="phoneNumber" maxlength="14">
                    </div>
                    <div class="row">
                        <label for="customerphone" class="dropdown_label">@Home.lbl_NearPos</label>
                        <input id="customerNearpos" type="text" placeholder="@Home.plh_NearPos" name="nearpos" maxlength="50">
                    </div>
                    <div class="row">
                        <label for="customerAgreeTerm" class="custom_checkbox custom_checkbox_light"><input type="checkbox" name="customerAgreeTerm" id="customerAgreeTerm">@Home.lbl_reg_note</label>
                    </div>
                    <input type="hidden" id="DriveId" />
                    <input type="hidden" id="ScheduleId" />
                    <a class="button submit red right" id="btnCreate">@Home.btn_register</a>
                </div>
            </div>
        </div>

    </div>
    <div class="grid_4 sidebar">
        <div class="box">
            <h3>@Home.lbl_Find_Car_By_Location</h3>
            <div class="box-content widget-categories">
                <ul>
                    <li><a href="#">Nam Định<span>50</span></a></li>
                    <li><a href="#">Thái Bình<span>25</span></a></li>
                    <li><a href="#">Lào Cai<span>20</span></a></li>
                    <li><a href="#">Yên Bái<span>10</span></a></li>
                    <li><a href="#">Thanh Hóa<span>5</span></a></li>
                </ul>
            </div>
        </div>

        <div class="box">
            <h3>@Home.lbl_sp_online</h3>
            <div class="box-content widget_online_support">
                <div class="row">
                    <img src="~/Content/Images/frontend-images/johnsdoe.jpg" alt="" class="span6">
                    <div class="span6">
                        <span class="online_support_title">Nguyễn Xuân Phúc</span>
                        <p>@Home.lbl_administator</p>
                    </div>
                </div>
                <a href="#" class="button green big wide "><i class="icomoon-volume-medium"></i> 098.462.2793</a>
            </div>
        </div>

        <div class="box">
            <h3>Về chúng tôi</h3>
            <div class="box-content">
                <p>Ứng dụng tìm kiếm taxi đường dài, giá rẻ. Chúng tôi sẽ đem lại cho Quí khách hàng những chọn lựa tốt với mức chi phí thấp nhất.</p>
            </div>
        </div>

    </div>
</div>
<div id="mapdirdd" style="display:none;">    
</div>
@section HomeFooter{
    <script type="text/javascript">
        $(function() {
            $.datetimepicker.setLocale('vi');
            jQuery("#timestart").datetimepicker({
                format: 'd-m-Y H:i',
                minDate: 0,
                lang: 'vi',
                onChangeDateTime: function(dp, $input) {
                    SearchModel.setStartDate(dp);
                }
            });
        });

        function RegisterCar(data) {
            $.fancybox({
                href: "#login_form",
                padding: 0,
                onClosed: function () {
                    $("#login_error").hide();
                }
            });
            document.getElementById("DriveId").value = data.DriveId;
            document.getElementById("ScheduleId").value = data.ScheduleId;
        }
      
        var CustomerRegisterCar = {
            DriveId: "",
            CustomerFullName: "",
            CustomerPhoneNumber: "",
            NearLocation: "",
            ScheduleId: ""
        }

        var SearchModel = {
            StartLocationLat: "",
            StartLocationLng: "",
            EndLocationLat: "",
            EndLocationLng: "",
            CarType: "",
            StartDate: "",
            setStartDate: function(date) {
                var monthsName = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                this.StartDate = date.getDate() + "-" + monthsName[date.getMonth()] + "-" + date.getFullYear() + " " + date.getHours() + ":" + date.getMinutes();
            }
        }

        $('#searchCar').click(function() {
            if (startPointPlace != null && endPointPlace != null) {
                SearchModel.StartLocationLat = startPointPlace.geometry.location.lat();
                SearchModel.StartLocationLng = startPointPlace.geometry.location.lng();
                SearchModel.EndLocationLat = endPointPlace.geometry.location.lat();
                SearchModel.EndLocationLng = endPointPlace.geometry.location.lng();
                SearchModel.CarType = '';
                $.ajax({
                    url: "/Home/Search",
                    type: 'POST',
                    data: JSON.stringify(SearchModel),
                    dataType: 'json',
                    contentType: "application/jsonrequest; charset=utf-8",
                    success: function (data) {
                        $('#vendor').css("display", "block");
                        $('#search_result').empty();
                        if (data.length === undefined) {
                            $('#no_result').css("display", "block");
                            $('#no_result').html("Không có kết quả nào được tìm thấy");
                            $('#search_result').css("display", "none");
                        } else {
                            $('#no_result').css("display", "none");
                            $('#search_result').css("display", "block");

                            for (var count in data)
                            {
                                var routeData = JSON.stringify(data[count]);
                                var startDate = data[count].StartDate;
                                var result_html = $("<div class='box-content clearfix'><div class='half left'><div class='row'>" +
                                    "<img src='/Content/Images/frontend-images/johnsdoe.jpg' alt='' class='span4'>" +
                                    "<div class='span8 vendor_info'><span class='vendor_title'>" + data[count].UserFullName + "</span><span>Thành phố: <strong>Hà nội</strong></span><span>Loại xe: <strong>4 chỗ ngồi</strong></span><span>Thời gian: <strong>" + parseJsonDate(startDate) + "</strong></span></div>" +
                                    "</div></div>" +
                                    "<div class='half right'><a href='#' onclick='RegisterCar(" + routeData + ");return false;' class='button blue big wide show_login_form'><i class='icomoon-volume-medium'></i>" + data[count].UserPhoneNumber + "</a></div>" +
                                    "</div>");
                                $('#search_result').append(result_html);
                            }
                        }
                        
                    }
                });
            }
        })

        function parseJsonDate(jsonDateString) {
            var today = new Date(parseInt(jsonDateString.replace('/Date(', '')));
            var dd = today.getDate();
            var mm = today.getMonth() + 1; //January is 0!

            var yyyy = today.getFullYear();
            var hh = addZero(today.getHours());
            var m = addZero(today.getMinutes());
            if (dd < 10) {
                dd = '0' + dd
            }
            if (mm < 10) {
                mm = '0' + mm
            }
            return today = dd + '/' + mm + '/' + yyyy + ' - ' + hh + ':' + m;
        }

        function addZero(i) {
            if (i < 10) {
                i = "0" + i;
            }
            return i;
        }
        var map = null;
        var latValue = 21.022736;
        var lngValue = 105.8019441;
        var startPointPlace = null;
        var endPointPlace = null;
        var origin_place_id = null;
        var destination_place_id = null;
        var directionsService = null;
        var directionsDisplay = null;
        var travel_mode = null;

        function loadScript(src) {
            var script = document.createElement("script");
            script.type = "text/javascript";
            document.getElementsByTagName("head")[0].appendChild(script);
            script.src = src;
        }

        loadScript('http://maps.googleapis.com/maps/api/js?key=AIzaSyDXIEOJsracks0-TTPmqvEnnMG3YPyh36U&v=3&libraries=places&sensor=false&callback=initialize');

        function initialize() {
            var mapOptions = {
                mapTypeControl: true
            };
            map = new google.maps.Map(document.getElementById('mapdirdd'),
                mapOptions);
            directionsDisplay = new google.maps.DirectionsRenderer;
            directionsService = new google.maps.DirectionsService;
            travel_mode = google.maps.TravelMode.DRIVING
            directionsDisplay.setMap(map);
            var myCenter = new google.maps.LatLng(latValue, lngValue);

        
            var geocoder = new google.maps.Geocoder;
            var infowindow = new google.maps.InfoWindow();

            var latlng = { lat: latValue, lng: lngValue };
            geocoder.geocode({ 'location': latlng }, function(results, status) {
                if (status === google.maps.GeocoderStatus.OK) {
                    if (results[1]) {
                        infowindow.setContent(results[1].formatted_address);
                    }
                }
            });
            google.maps.event.addDomListener(window, 'load', initialize);
        }

        $("#locate").click(function() {
            // Try HTML5 geolocation.
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(locate, showError);
            }
        });

        $("#clear_search").click(function () {
            $(':input').val('');
        });

        function showError(error) {
            switch (error.code) {
            case error.PERMISSION_DENIED:
                console.log("User denied the request for Geolocation.")
                break;
            case error.POSITION_UNAVAILABLE:
                console.log("Location information is unavailable.")
                break;
            case error.TIMEOUT:
                console.log("The request to get user location timed out.")
                break;
            case error.UNKNOWN_ERROR:
                console.log("An unknown error occurred.")
                break;
            }
        }

        function locate(position) {
            latValue = position.coords.latitude;
            lngValue = position.coords.longitude;
            initialize();
            var latlng = { lat: latValue, lng: lngValue };
            var geocoder = new google.maps.Geocoder;
            geocoder.geocode({ 'location': latlng }, function(results, status) {
                if (status === google.maps.GeocoderStatus.OK) {
                    if (results[1]) {
                        origin_place_id = results[1].place_id;
                        startPointPlace = results[1];
                        document.getElementById('startPoint').value = results[1].formatted_address;
                    }
                }
            });
        }

        function calcdir(event) {
            // Create the search box and link it to the UI element.
            var startPoint = document.getElementById('startPoint');
            var options = {
                componentRestrictions: { country: 'vn' } //Vietnam only
            };
            var startPointSearchBox = new google.maps.places.Autocomplete(startPoint, options);
            startPointSearchBox.addListener('place_changed', function() {
                startPointPlace = startPointSearchBox.getPlace();
                if (!startPointPlace.geometry) {
                    window.alert("Autocomplete's returned place contains no geometry");
                    return;
                }

                // If the place has a geometry, store its place ID and route if we have
                // the other place ID
                origin_place_id = startPointPlace.place_id;
            });
            var endPoint = document.getElementById('endPoint');
            var endPointSearchBox = new google.maps.places.Autocomplete(endPoint, options);
            endPointSearchBox.addListener('place_changed', function() {
                endPointPlace = endPointSearchBox.getPlace();
                if (!endPointPlace.geometry) {
                    window.alert("Autocomplete's returned place contains no geometry");
                    return;
                }

                // If the place has a geometry, store its place ID and route if we have
                // the other place ID
                destination_place_id = endPointPlace.place_id;
            });
        }

        function getDistanceAndTime() {
            var service = new google.maps.DistanceMatrixService();
            service.getDistanceMatrix({
                origins: [document.getElementById('startPoint').value],
                destinations: [document.getElementById('endPoint').value],
                travelMode: google.maps.TravelMode.DRIVING,
                unitSystem: google.maps.UnitSystem.METRIC,
                avoidHighways: false,
                avoidTolls: false
            }, function(response, status) {
                if (status == google.maps.DistanceMatrixStatus.OK && response.rows[0].elements[0].status != "ZERO_RESULTS") {
                    var distance = response.rows[0].elements[0].distance.text;
                    var duration = response.rows[0].elements[0].duration.text;
                    $('#distanceAndTime').text(distance + ' - ' + duration);

                } else {
                    alert("Unable to find the distance via road.");
                }
            });
        }

        $("#switchSearchValue").click(function() {
            var startPoint = document.getElementById('startPoint');
            var endPoint = document.getElementById('endPoint');
            var flag = startPoint.value;
            startPoint.value = endPoint.value;
            endPoint.value = flag;
            var placeFlag = startPointPlace;
            startPointPlace = endPointPlace;
            endPointPlace = placeFlag;
            var flagDirection = origin_place_id;
            origin_place_id = destination_place_id;
            destination_place_id = flagDirection;
        });
    </script>
    }
<!--BODY_END-->