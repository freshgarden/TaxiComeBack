@using TaxiCameBack.Website.App_LocalResources
@{
    Layout = "~/Views/Shared/_Home.cshtml";
}
<link href="@Url.Content("~/Content/datetimepicker/jquery.datetimepicker.css")" rel="stylesheet" />
<script src="@Url.Content("~/Content/datetimepicker/jquery.datetimepicker.full.min.js")"></script>
<!--The jQuery library is required and is referenced by default in _Layout.cshtml. -->
@Scripts.Render("~/js/signalr")
<!--Reference the autogenerated SignalR hub script. -->
<script src="~/signalr/hubs"></script>
<script>
        $(function () {
            // Reference the auto-generated proxy for the hub.
            var notification = $.connection.notificationHub;
            // Create a function that the hub can call back to display messages.
            notification.client.addNewMessageToPage = function (message) {
                window.alert(message);
            };
            // Start the connection.
            $.connection.hub.start().done(function () {
                $('#btnCreate').click(function () {
                    CustomerRegisterCar.DriveId = $('#DriveId').val();
                    CustomerRegisterCar.CustomerFullName = $('#customerFullName').val();
                    CustomerRegisterCar.CustomerPhoneNumber = $('#customerPhoneNumber').val();
                    CustomerRegisterCar.ScheduleId = $('#ScheduleId').val();
                    CustomerRegisterCar.NearLocation = $('#customerNearpos').val();
                    // Call the Send method on the hub.
                    notification.server.registerTaxi(CustomerRegisterCar);
                });
            });
        });
</script>
<!--BODY_START-->
<div class="container_12 clearfix">
    <div class="grid_8 content">
        <section id="search">
            <div class="tabbable tabbable_red">
                <ul class="nav-tabs">
                    <li class="active with_icon"><a href="#search_tab_1" data-toggle="tab"><i class="icomoon-search"></i>Tìm kiếm Taxi</a></li>
                    <li class="with_icon"><a href="#search_tab_2" data-toggle="tab" id="register_div"><i class="icomoon-plus"></i>Đăng ký xe</a></li>
                </ul>
                <div class="tab-content">
                    <div class="tab-pane active" id="search_tab_1">
                        <form id="homepage_search" action="#">
                            <div class="row">
                                <div class="span6">
                                    <label for="type" class="dropdown_label">Điểm đi</label>
                                    <input id="startPoint" onkeypress="return calcdir(event)" type="text" placeholder="@Home.plh_StartPoint" name="start_position">
                                </div>
                                <div class="span6">
                                    <label for="category" class="dropdown_label">Điểm đến</label>
                                    <input id="endPoint" onkeypress="return calcdir(event)" type="text" placeholder="@Home.plh_EndPoint" autocomplete="off" name="end_position">
                                </div>
                            </div>
                            <div class="row">
                                <div class="span6">
                                    <label for="location" class="dropdown_label">Ngày khởi hành</label>
                                    <input id="timestart" type="text" placeholder="@Home.plh_TimeStart" name="start_date" autocomplete="off">
                                </div>
                            </div>
                            <div class="row last_row">
                                <div class="span4">
                                </div>
                                <div class="span8 clear_submit_buttons">
                                    <a id="locate" href="#" class="clear_filters"><i class="icon-screenshot"></i> Định vị</a>
                                    <a href="#"  id="switchSearchValue" class="clear_filters"><i class="icon-exchange"></i> @Home.btn_switch_title</a>
                                    <a class="button yellow right" id="searchCar">@Home.btn_search_title</a>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="tab-pane" id="search_tab_2">
                        <form id="homepage_search" action="#">
                            <div class="row">
                                <div class="span6">
                                    <label for="type" class="dropdown_label">Điểm đi</label>
                                    <input type="text" placeholder="Nhập điểm đi của bạn" id="reg_start_position">
                                </div>
                                <div class="span6">
                                    <label for="category" class="dropdown_label">Điểm đến</label>
                                    <input type="text" placeholder="Nhập điểm đến của bạn" id="reg_end_position">
                                </div>
                            </div>
                            <div class="row">
                                <div class="span6">
                                    <label for="location" class="dropdown_label">Gần vị trí</label>
                                    <input type="text" placeholder="Nhập vị trí gần điểm đến của bạn" id="reg_near_position">
                                </div>
                            </div>
                            <div class="row">
                                <div class="span6">
                                    <label for="location" class="dropdown_label">Ngày khởi hành</label>
                                    <input type="text" placeholder="Nhập ngày giờ khởi hành của bạn" id="reg_start_date">
                                </div>
                            </div>
                            <div class="row">
                                <div class="span6">
                                    <label for="location" class="dropdown_label">Họ và tên</label>
                                    <input type="text" placeholder="Nhập họ và tên của bạn" id="reg_full_name">
                                </div>
                                <div class="span6">
                                    <label for="location" class="dropdown_label">Số điện thoại</label>
                                    <input type="text" placeholder="Nhập số điện thoại của bạn" id="reg_phone_number">
                                </div>
                            </div>
                            <div class="row">
                                <div class="span12">
                                    <label for="location" class="dropdown_label">Ghi chú</label>
                                    <textarea name="description" id="reg_note" placeholder="Nhập ghi chú của bạn"></textarea>
                                </div>
                            </div>
                            <div class="row last_row">
                                <div class="span6">
                                </div>
                                <div class="span6 clear_submit_buttons">
                                    <a id="clearConditions" href="#" class="clear_filters"><i class="icon-remove"></i> Xóa điều kiện</a>
                                    <a  id="customerRegister"  class="button submit yellow right">Đăng ký</a>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </section>

        <section id="featured_news" class="clearfix">
            <div class="tabbable">
                <label id="distanceAndTime" class="help_link"></label>
                <ul class="nav-tabs">
                    <li class="active"><a href="#featured_news_tab_1" data-toggle="tab">Kết quả tìm kiếm</a></li>
                </ul>
                <div class="tab-content custom_scrollbar">
                    <div class="tab-pane active" id="featured_news_tab_1">
                        <article id="noSearchResult" class="featured_post clearfix">
                            <h4 id="noSearchResult_title">Dịch vụ tìm kiếm taxi đường dài</h4>
                            <p>
                                Ứng dụng tìm kiếm taxi đường dài, giá rẻ với chi phí chỉ khoảng 5 đến 6 ngàn đồng/km, rẻ bằng một nửa so với taxi truyền thống. Chúng tôi sẽ đem lại cho Quí khách hàng những chọn lựa tốt với mức chi phí thấp nhất.
                            </p>
                        </article>
                    </div>
                </div>
            </div>
        </section>

        <div class="login_form_modal_container">
            <div id="login_form" class="box">
                <h3>Thông tin lộ trình</h3>
                <div class="box-content clearfix">
                    <div class="row">
                        <label for="drivername" class="dropdown_label">Tên tài xế</label>
                        <input id="driveName" type="text" name="drivername" value="Đỗ Anh Tú" disabled>
                    </div>
                    <div class="row">
                        <label for="driverphone" class="dropdown_label">Số điện thoại tài xế</label>
                        <input id="drivePhone" type="text" name="driverphone" value="098.255.2067" disabled>
                    </div>
                    <form action="#">
                        <div class="row">
                            <label for="customername" class="dropdown_label">Họ và tên</label>
                            <input type="text" placeholder="Nhập họ và tên của bạn" name="customername">
                        </div>
                        <div class="row">
                            <label for="customerphone" class="dropdown_label">Số điện thoại</label>
                            <input type="text" placeholder="Nhập số điện thoại của bạn" name="customerphone">
                        </div>
                        <input type="hidden" id="DriveId" />
                        <input type="hidden" id="ScheduleId" />
                        <a class="button submit red right">Đăng ký</a>
                    </form>
                </div>
            </div>
        </div>

    </div>
    <div class="grid_4 sidebar">
        <div class="box">
            <h3>Danh sách xe đi các tỉnh</h3>
            <div class="box-content widget-categories">
                <ul>
                    <li><a href="#">Nam Định<span>50</span></a></li>
                    <li><a href="#">Thái Bình<span>25</span></a></li>
                    <li><a href="#">Lào Cai<span>20</span></a></li>
                    <li><a href="#">Yên Bái<span>10</span></a></li>
                    <li><a href="#">Thanh Hóa<span>5</span></a></li>
                </ul>
            </div>
        </div>

        <div class="box">
            <h3>Trợ giúp trực tuyến</h3>
            <div class="box-content widget_online_support">
                <div class="row">
                    <img src="~/Content/Images/frontend-images/johnsdoe.jpg" alt="" class="span6">
                    <div class="span6">
                        <span class="online_support_title">Nguyễn Xuân Phúc</span>
                        <p>Quản trị viên</p>
                    </div>
                </div>
                <a href="#" class="button blue big wide "><i class="icomoon-volume-medium"></i>098.462.2793</a>
                <a href="#">Liên hệ với đội hỗ trợ</a><br>
            </div>
        </div>
    </div>
</div>
<div id="mapdirdd" style="display:none;">    
</div>
@section HomeFooter{
    <script type="text/javascript">
        $(function() {
            $.datetimepicker.setLocale('vi');
            jQuery("#timestart").datetimepicker({
                format: 'd-m-Y H:i',
                minDate: 0,
                lang: 'vi',
                onChangeDateTime: function(dp, $input) {
                    SearchModel.setStartDate(dp);
                }
            });
        });

        function RegisterCar(data) {
            $("#driveName").val(data.UserFullName);
            $("#drivePhone").val(data.UserPhoneNumber);
            document.getElementById("DriveId").value = data.DriveId;
            document.getElementById("ScheduleId").value = data.ScheduleId;
            $.fancybox({ href: "#login_form" });
            
            //$('.login_form_modal_container').css("display", "block");
        }
      
        var CustomerRegisterCar = {
            DriveId: "",
            CustomerFullName: "",
            CustomerPhoneNumber: "",
            NearLocation: "",
            ScheduleId: ""
        }
    //    $('#btnCreate').click(function() {
    //        if ($("#customerAgreeTerm").is(':checked')) {
    //            CustomerRegisterCar.DriveId = $('#DriveId').val();
    //            CustomerRegisterCar.CustomerFullName = $('#customerFullName').val();
    //            CustomerRegisterCar.CustomerPhoneNumber = $('#customerPhoneNumber').val();
    //            CustomerRegisterCar.NearLocation = $('#customerNearpos').val();
    //
    //            $.ajax({
    //                url: "/Home/CustomerRegisterCar",
    //                type: 'POST',
    //                data: JSON.stringify(CustomerRegisterCar),
    //                dataType: 'json',
    //                contentType: "application/jsonrequest; charset=utf-8",
    //                success: function(data) {
    //                    if (data.length === undefined) {
    //                        //test success message
    //                        SetCustomerRegCarSuccessMessage("Đăng ký thành công");
    //                    } else {
    //                        SetCustomerRegCarSuccessMessage("Đăng ký thành công");
    //                    }
    //                }
    //            });
    //        } else {
    //            SetCustomerRegCarErrorMessage("@Home.customer_agree");
    //        }
    //
    //    })

        var SearchModel = {
            StartLocationLat: "",
            StartLocationLng: "",
            EndLocationLat: "",
            EndLocationLng: "",
            CarType: "",
            StartDate: "",
            setStartDate: function(date) {
                var monthsName = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                this.StartDate = date.getDate() + "-" + monthsName[date.getMonth()] + "-" + date.getFullYear() + " " + date.getHours() + ":" + date.getMinutes();
            }
        }

        $('#searchCar').click(function() {
            if (startPointPlace != null && endPointPlace != null) {
                SearchModel.StartLocationLat = startPointPlace.geometry.location.lat();
                SearchModel.StartLocationLng = startPointPlace.geometry.location.lng();
                SearchModel.EndLocationLat = endPointPlace.geometry.location.lat();
                SearchModel.EndLocationLng = endPointPlace.geometry.location.lng();
                SearchModel.CarType = ''; //$('input[name=cartype]:checked').val();
                $.ajax({
                    url: "/Home/Search",
                    type: 'POST',
                    data: JSON.stringify(SearchModel),
                    dataType: 'json',
                    contentType: "application/jsonrequest; charset=utf-8",
                    success: function (data) {
                        if (data.length === undefined) {
                            $("#noSearchResult_title").html("<span class='text-danger'>Không có kết quả nào được tìm thấy </span>");
                            $('#noSearchResult').css("display", "block");
                        } else {
                            $('#noSearchResult').css("display", "none");

                            for (var count in data) {
                                var routeData = JSON.stringify(data[count]);
                                var startDate = data[count].StartDate;
                                var result_html = $("<article class='featured_post clearfix'><h4>Dịch vụ tìm kiếm taxi đường dài - Lựa chọn số" + ++count + "</h4>" +
                                "<span class='post_date'>" + parseJsonDate(startDate)+ "</span>" +
                                "<p>Ứng dụng tìm kiếm taxi đường dài, giá rẻ với chi phí chỉ khoảng 5 đến 6 ngàn đồng/km, rẻ bằng một nửa so với taxi truyền thống. Chúng tôi sẽ đem lại cho Quí khách hàng những chọn lựa tốt với mức chi phí thấp nhất.</p>" +
                                "<a class='blog_comments show_login_form' href='#' onclick='RegisterCar(" + routeData + ")'>Xem thông tin</a>" +
                                "</article>");
                                $('#featured_news_tab_1').append(result_html);
                            }
                            getDistanceAndTime();
                        }
                    }
                });
            }
        })
        function parseJsonDate(jsonDateString) {
             
            var today = new Date(parseInt(jsonDateString.replace('/Date(', '')));
            var dd = today.getDate();
            var mm = today.getMonth() + 1; //January is 0!

            var yyyy = today.getFullYear();
            var hh = addZero(today.getHours());
            var m = addZero(today.getMinutes());
            if (dd < 10) {
                dd = '0' + dd
            }
            if (mm < 10) {
                mm = '0' + mm
            }
            return today = dd + '/' + mm + '/' + yyyy + ' - ' + hh + ':' + m;
        }

        function addZero(i) {
            if (i < 10) {
                i = "0" + i;
            }
            return i;
        }
        var map = null;
        var latValue = 21.022736;
        var lngValue = 105.8019441;
        var startPointPlace = null;
        var endPointPlace = null;
        var origin_place_id = null;
        var destination_place_id = null;
        var directionsService = null;
        var directionsDisplay = null;
        var travel_mode = null;

        function loadScript(src) {
            var script = document.createElement("script");
            script.type = "text/javascript";
            document.getElementsByTagName("head")[0].appendChild(script);
            script.src = src;
        }

        loadScript('http://maps.googleapis.com/maps/api/js?key=AIzaSyA1naPg1USZOsy3uiEJv0A71GwcGeaOTS8&v=3&libraries=places&sensor=false&callback=initialize');

        function initialize() {
        
            var mapOptions = {
                mapTypeControl: true
            };
            map = new google.maps.Map(document.getElementById('mapdirdd'),
                mapOptions);
            directionsDisplay = new google.maps.DirectionsRenderer;
            directionsService = new google.maps.DirectionsService;
            travel_mode = google.maps.TravelMode.DRIVING
            directionsDisplay.setMap(map);
            var myCenter = new google.maps.LatLng(latValue, lngValue);

        
            var geocoder = new google.maps.Geocoder;
            var infowindow = new google.maps.InfoWindow();

            var latlng = { lat: latValue, lng: lngValue };
            geocoder.geocode({ 'location': latlng }, function(results, status) {
                if (status === google.maps.GeocoderStatus.OK) {
                    if (results[1]) {
                        infowindow.setContent(results[1].formatted_address);
                    }
                }
            });


            google.maps.event.addDomListener(window, 'load', initialize);

        }

        $("#locate").click(function() {
            // Try HTML5 geolocation.
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(locate, showError);
            }
        });

        function showError(error) {
            switch (error.code) {
            case error.PERMISSION_DENIED:
                console.log("User denied the request for Geolocation.")
                break;
            case error.POSITION_UNAVAILABLE:
                console.log("Location information is unavailable.")
                break;
            case error.TIMEOUT:
                console.log("The request to get user location timed out.")
                break;
            case error.UNKNOWN_ERROR:
                console.log("An unknown error occurred.")
                break;
            }
        }

        function locate(position) {
            latValue = position.coords.latitude;
            lngValue = position.coords.longitude;
            initialize();
            var latlng = { lat: latValue, lng: lngValue };
            var geocoder = new google.maps.Geocoder;
            geocoder.geocode({ 'location': latlng }, function(results, status) {
                if (status === google.maps.GeocoderStatus.OK) {
                    if (results[1]) {
                        origin_place_id = results[1].place_id;
                        startPointPlace = results[1];
                        document.getElementById('startPoint').value = results[1].formatted_address;
                    }
                }
            });
        }

        function calcdir(event) {
        
            // Create the search box and link it to the UI element.
            var startPoint = document.getElementById('startPoint');
            var options = {
                componentRestrictions: { country: 'vn' } //Vietnam only
            };
            var startPointSearchBox = new google.maps.places.Autocomplete(startPoint, options);
            startPointSearchBox.addListener('place_changed', function() {
                startPointPlace = startPointSearchBox.getPlace();
                if (!startPointPlace.geometry) {
                    window.alert("Autocomplete's returned place contains no geometry");
                    return;
                }

                // If the place has a geometry, store its place ID and route if we have
                // the other place ID
                origin_place_id = startPointPlace.place_id;
            });
            var endPoint = document.getElementById('endPoint');
            var endPointSearchBox = new google.maps.places.Autocomplete(endPoint, options);
            endPointSearchBox.addListener('place_changed', function() {
                endPointPlace = endPointSearchBox.getPlace();
                if (!endPointPlace.geometry) {
                    window.alert("Autocomplete's returned place contains no geometry");
                    return;
                }

                // If the place has a geometry, store its place ID and route if we have
                // the other place ID
                destination_place_id = endPointPlace.place_id;
            });

        }
       

        function getDistanceAndTime() {
            var service = new google.maps.DistanceMatrixService();
            service.getDistanceMatrix({
                origins: [document.getElementById('startPoint').value],
                destinations: [document.getElementById('endPoint').value],
                travelMode: google.maps.TravelMode.DRIVING,
                unitSystem: google.maps.UnitSystem.METRIC,
                avoidHighways: false,
                avoidTolls: false
            }, function(response, status) {
                if (status == google.maps.DistanceMatrixStatus.OK && response.rows[0].elements[0].status != "ZERO_RESULTS") {
                    var distance = response.rows[0].elements[0].distance.text;
                    var duration = response.rows[0].elements[0].duration.text;
                    $('#distanceAndTime').text(distance + ' - ' + duration);

                } else {
                    alert("Unable to find the distance via road.");
                }
            });
        }

        $("#switchSearchValue").click(function() {
            var startPoint = document.getElementById('startPoint');
            var endPoint = document.getElementById('endPoint');
            var flag = startPoint.value;
            startPoint.value = endPoint.value;
            endPoint.value = flag;
            var placeFlag = startPointPlace;
            startPointPlace = endPointPlace;
            endPointPlace = placeFlag;
            var flagDirection = origin_place_id;
            origin_place_id = destination_place_id;
            destination_place_id = flagDirection;
        });
    </script>
    }
<!--BODY_END-->