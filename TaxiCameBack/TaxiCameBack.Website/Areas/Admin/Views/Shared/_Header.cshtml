@using TaxiCameBack.Website.Application.Security
@using TaxiCameBack.Core.Constants
@using TaxiCameBack.Website.Application

@Scripts.Render("~/js/signalr")
<!--Reference the autogenerated SignalR hub script. -->
<script src="@Scripts.Url("~/signalr/hubs")"></script>
<link href="@Url.Content("~/Content/bootstrap-notification/bootstrap-notifications.min.css")" rel="stylesheet" />
@if (SessionPersister.Roles.Contains(AppConstants.StandardMembers))
{
    <script type="text/javascript">
        $(function () {
            // Reference the auto-generated proxy for the hub.
            var notification = $.connection.notificationHub;
            // Create a function that the hub can call back to display messages.
            notification.client.addRegisted = function () {
                updateNotificationCount();
            };
            notification.client.updateReceived = function () {
                updateNotification();
            }
            notification.client.updateResult = function (message) {
                window.alert(message);
            }
            // Start the connection.
            $.connection.hub.start().done(function () {
                console.log('Notification hub started');
                notification.server.addDriver("@SessionPersister.Username");
                $('#notifications-toggle').click(function (e) {
                    e.stopPropagation();
                    showNotificationPanel(true);
                    updateNotification();
                });
            });
            // hide notifications
            $('html').click(function () {
                showNotificationPanel(false);
            });

            window.receivedRide = function (notificationId, scheduleId, userId) {
                notification.server.received(notificationId, scheduleId, userId);
            }

            window.formatPhone = function (phonenumber) {
                if (!phonenumber) {
                    return "undefined";
                }

                if (phonenumber.toString().length === 10) {
                    return phonenumber.replace(/(\d\d\d)(\d\d\d)(\d\d\d\d)/, '$1.$2.$3');
                }
                return phonenumber.replace(/(\d\d\d\d)(\d\d\d)(\d\d\d\d)/, '$1.$2.$3');
            }

            window.formatDate = function (jsonDateString) {
                var today = new Date(parseInt(jsonDateString.replace('/Date(', '')));
                var dd = today.getDate();
                var mm = today.getMonth() + 1; //January is 0!

                var yyyy = today.getFullYear();
                var hh = addZero(today.getHours());
                var m = addZero(today.getMinutes());
                if (dd < 10) {
                    dd = '0' + dd
                }
                if (mm < 10) {
                    mm = '0' + mm
                }
                return today = dd + '/' + mm + '/' + yyyy + ' - ' + hh + ':' + m;
            }

            window.addZero = function (i) {
                if (i < 10) {
                    i = "0" + i;
                }
                return i;
            }

            window.toJavaScriptDate = function (value) {
                var pattern = /Date\(([^)]+)\)/;
                var results = pattern.exec(value);
                var dt = new Date(parseFloat(results[1]));
                return timeSince(dt);
            }

            window.timeSince = function (date) {

                var seconds = Math.floor((new Date() - date) / 1000);

                var interval = Math.floor(seconds / 31536000);

                if (interval > 1) {
                    return date.getDate() + "-" + (date.getMonth() + 1) + "-" + date.getFullYear();
                }
                interval = Math.floor(seconds / 2592000);
                if (interval > 1) {
                    return date.getDate() + "-" + (date.getMonth() + 1) + "-" + date.getFullYear();
                }
                interval = Math.floor(seconds / 86400);
                if (interval > 1) {
                    return interval + " ngày trước";
                }
                interval = Math.floor(seconds / 3600);
                if (interval > 1) {
                    return interval + " giờ trước";
                }
                interval = Math.floor(seconds / 60);
                if (interval > 1) {
                    return interval + " phút trước";
                }
                return Math.floor(seconds) + " giây trước";
            }

            // update notification
            function updateNotification() {
                $('#notifications-content').empty();
                $('#notifications-content').append($('<li>Loading...</li>'));
                $.ajax({
                    type: 'GET',
                    url: '/Schedule/GetNotifications',
                    success: function (response) {
                        $('#notifications-content').empty();
                        $('.count').attr('data-count', response[0].Total);
                        $('#totalNotification').html(response[0].totalNotification);
                        if (response.length === 0) {
                            $('#notifications-content').append($('<li><a href="#">Không có kết quả nào</a></li>'));
                        }
                        $.each(response, function (index, value) {
                            var scheduleLocation = "<b>Chuyến đi:</b> " + value.BeginLocation + " - " + value.EndLocation;
                            var startDate = "<b>Thời gian:</b> " + formatDate(value.StartDate);
                            var nearLocation = "<b>Vị trí đón:</b> " + value.NearLocation;
                            var message = "<b>Lời nhắn:</b> " + value.Message;
                            var sType = value.Type === 0 ? '<span class="label label-primary">Khách hàng đặt xe</span>' : '<span class="label label-success">Tài xế đặt xe</span>';
                            var type = "<b>Loại:</b> " + sType;
                            var newNotification = $('<li class="notification"></li>');
                            var media = $('<div class="media"></div>');
                            var mediaBody = $('<div class="media-body"></div>');
                            var notificationTitle = $('<strong class="notification-title">' + value.CustomerFullname + ' - ' + formatPhone(value.CustomerPhoneNumber) + '</strong>');
                            var description;
                            if (value.Message) {
                                description = $('<p class="notification-desc">' + scheduleLocation + '<br/>' + startDate + '<br/>' + nearLocation + '<br/>' + type + "<br/>" + message + '</p>');
                            } else {
                                description = $('<p class="notification-desc">' + scheduleLocation + '<br/>' + nearLocation + '<br/>' + type + '</p>');
                            }
                            var notificationDesc = description;
                            var notificationMeta = $('<div class="notification-meta"></div>');
                            var timeStamp = $('<small class="timestamp">' + toJavaScriptDate(value.CreateDate) + '</small>');
                            var receiveButton = $('<button id="btnAccept" class="pull-right btn btn-success btn-md" onclick="receivedRide(\'' + value.Id + '\',\'' + value.ScheduleId + '\',\'' + value.ScheduleUserId + '\');">Nhận</button>');

                            mediaBody = mediaBody.append(notificationTitle).append(notificationDesc.append(notificationMeta.append(timeStamp).append(receiveButton)));
                            media = media.append(mediaBody);
                            $('#notifications-content').append(newNotification.append(media));
                        });
                    },
                    error: function (error) {
                        console.log(error);
                    }
                });
            }

            // update notification count
            function updateNotificationCount() {
                var count = 0;
                count = parseInt($('.count').attr("data-count")) || 0;
                count++;
                $('.count').attr('data-count', count);
                showNotificationPanel(false);
            }

            $("#viewmore").click(function() {
                showNotificationPanel(false);
            });

            $.ajax({
                type: 'GET',
                url: '/Schedule/GetCountNotifications',
                success: function (response) {
                    if (response.length > 0) {
                        $('.count').attr('data-count', response);
                    }
                },
                error: function (error) {
                    console.log(error);
                }
            });

            window.showNotificationPanel = function(show) {
                var notificationPanel = document.getElementById("notifications");
                if (show) {
                    notificationPanel.classList.add("open");
                } else {
                    notificationPanel.classList.remove("open");
                }
            }
        });
    </script>
    <style>
        .dropdown-container {
            left: 50%;
            right: auto;
            text-align: center;
            transform: translate(-50%, 0);
        }
    </style>
}
<header class="main-header">
    <!-- Logo -->
    <a href="#" class="logo">
        <!-- mini logo for sidebar mini 50x50 pixels -->
        <span class="logo-mini"><b>TQV</b></span>
        <!-- logo for regular state and mobile devices -->
        <span class="logo-lg"><img src="~/Content/Images/logo/logovnl_03.png" class="img-responsive center-block" style="margin-top:5px;" alt="Logo" /></span>
    </a>
    <!-- Header Navbar: style can be found in header.less -->
    <nav class="navbar navbar-static-top">
        <!-- Sidebar toggle button-->
        <a href="#" class="sidebar-toggle" data-toggle="offcanvas" role="button">
            <span class="sr-only">Toggle navigation</span>
        </a>
        <!-- Navbar Right Menu -->
        <div class="navbar-custom-menu">
            <ul class="nav navbar-nav">
                @if (SessionPersister.Roles.Contains(AppConstants.StandardMembers))
                {
                    <li class="dropdown dropdown-notifications" id="notifications">
                        <a href="#notifications-panel" class="dropdown-toggle" id="notifications-toggle">
                            <i data-count="" class="count glyphicon glyphicon-bell notification-icon"></i>
                        </a>

                        <div class="dropdown-container">

                            <div class="dropdown-toolbar">
@*                                <div class="dropdown-toolbar-actions">*@
@*                                    <a href="#">Mark all as read</a>*@
@*                                </div>*@
                                <h3 class="dropdown-toolbar-title">Notifications <i data-count="" class="count"></i></h3>
                            </div><!-- /dropdown-toolbar -->

                            <ul class="dropdown-menu" id="notifications-content">

                            </ul>

                            <div class="dropdown-footer text-center">
                                <a id="viewmore" href="@Url.Action("Index", "Notification")">View <span id="totalNotification"></span> more...</a>
                            </div><!-- /dropdown-footer -->

                        </div><!-- /dropdown-container -->
                    </li>
                }

                <!-- User Account: style can be found in dropdown.less -->
                <li class="dropdown user user-menu">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                        @if (string.IsNullOrEmpty(SessionPersister.UserImageUrl))
                        {
                            <img src="~/Content/Images/default-user-image.png" class="user-image" alt="User Image">
                        }
                        else
                        {
                            <img src="@AppHelpers.MemberImage(SessionPersister.UserId, SessionPersister.UserImageUrl, SessionPersister.Username, AppConstants.AvatarProfileSize)" class="user-image" alt="User Image">
                        }
                        <span class="hidden-xs">@SessionPersister.Username</span>
                    </a>
                    <ul class="dropdown-menu">
                        <!-- User image -->
                        <li class="user-header">
                            @if (string.IsNullOrEmpty(SessionPersister.UserImageUrl))
                            {
                                <img src="~/Content/Images/default-user-image.png" class="img-circle" alt="User Image">
                            }
                            else
                            {
                                <img src="@AppHelpers.MemberImage(SessionPersister.UserId, SessionPersister.UserImageUrl, SessionPersister.Username, AppConstants.AvatarProfileSize)" class="img-circle" alt="User Image">
                            }
                            <p>
                                @if (string.IsNullOrEmpty(SessionPersister.FullName))
                                {
                                    @Header.default_full_name
                                }
                                else
                                {
                                    if (SessionPersister.Roles.Contains(AppConstants.AdminRoleName))
                                    {
                                        @(SessionPersister.FullName + " - " + @UserProfile.manager)
                                    }
                                    else
                                    {
                                        @(SessionPersister.FullName + " - " + @UserProfile.drive)
                                    }
                                }
                            </p>
                        </li>

                        <!-- Menu Footer-->
                        <li class="user-footer">
                            <div class="pull-left">
                                <a href="@Url.Action("EditProfile", "Account")" class="btn btn-default btn-flat">@Header.update_profile</a>
                            </div>
                            <div class="pull-right">
                                <a href="@Url.Action("LogOff", "Account", new { area = "" })" class="btn btn-default btn-flat">@Header.sign_out</a>
                            </div>
                        </li>
                    </ul>
                </li>
            </ul>
        </div>
    </nav>
</header>